---
title: "Integration test for distance sampling parts of MRSea"
author: "LAS Scott-Hayward, C Fell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


-------

```{r echo=FALSE, message=FALSE, warning=FALSE}
devtools::install_github("lindesaysh/MRSea")
require(MRSea)
knitr::opts_chunk$set(fig=TRUE, warning=FALSE, message=FALSE, eval=TRUE, comment = '')
```

## Introduction
This is the first in a series of tests that can be used to check changes to the MRSea package do not break previously working elements. They replicate the case study in the vignette but broken down into chunks. This first one checks the functions in MRSea that adjust for detection.

## Distance sampling using the ```mrds``` library

1. Load data and fit detection function (Distance Sampling)
```{r message=FALSE}
#devtools::load_all(path='../../MRSea/')
# we will use the dataset with a known re-distribution of animals
data(dis.data.re)
dis.data<-dis.data.re
require(mrds) # distance sampling package
result <- ddf(dsmodel=~mcds(key="hn", formula=~1),
              data = dis.data, method="ds", 
              meta.data=list(width=250))
```

2. Adjust sightings for detectability 
```{r dist, cache=TRUE, results='hide', warning=FALSE, message=FALSE}
# create.NHAT and create.count.data are MRSea functions to adjust the 
# sightings for the detection function estimated above.
dis.data <- create.NHAT(dis.data,result)
count.data <- create.count.data(dis.data)
```

## Compare to saved data

```{r compare_dis, echo=FALSE}

dis_data_read_in <- read.csv("2.dis.data.csv")

# has create Nhat created the extra columns
if (length(colnames(dis_data_read_in)) == length(colnames(dis.data))) {
  dis_data_check <- (length(colnames(dis_data_read_in)) - sum(colnames(dis.data) == colnames(dis_data_read_in))) == 0
  dis_object_check <- sum(dis.data$object, na.rm=T) == sum(dis_data_read_in$object, na.rm=T)
  dis_distance_check <- sum(dis.data$distance, na.rm=T) == sum(dis_data_read_in$distance, na.rm=T)
  dis_area_check <- sum(dis.data$area) == sum(dis_data_read_in$area)
  dis_size_check <- sum(dis.data$size, na.rm=T) == sum(dis_data_read_in$size, na.rm=T)
  dis_nhat_check <- round(sum(dis.data$NHAT, na.rm=T), 6) == round(sum(dis_data_read_in$NHAT, na.rm=T), 6)
} else {
  dis_data_check <- FALSE
  if ('object' %in% colnames(dis.data)) {
    dis_object_check <- sum(dis.data$object, na.rm=T) == sum(dis_data_read_in$object, na.rm=T)
  } else {
    dis_object_check <- FALSE
  }
  if ('distance' %in% colnames(dis.data)) {
    dis_distance_check <- sum(dis.data$distance, na.rm=T) == sum(dis_data_read_in$distance, na.rm=T)
  } else {
    dis_distance_check <- FALSE
  }
  if ('area' %in% colnames(dis.data)) {
    dis_area_check <- sum(dis.data$area, na.rm=T) == sum(dis_data_read_in$area, na.rm=T)
  } else {
    dis_area_check <- FALSE
  }
  if ('size' %in% colnames(dis.data)) {
    dis_size_check <- sum(dis.data$size, na.rm=T) == sum(dis_data_read_in$size, na.rm=T)
  } else {
    dis_size_check <- FALSE
  }
  if ('NHAT' %in% colnames(dis.data)) {
    dis_nhat_check <- round(sum(dis.data$NHAT, na.rm=T), 6) == round(sum(dis_data_read_in$NHAT, na.rm=T), 6)
  } else {
    dis_nhat_check <- FALSE
  }
}



```

```{r dis_text, echo=FALSE, results='asis'}

cat('The create NHAT function created all the expected columns is', dis_data_check, '\n\n')
cat('The create NHAT function correctly created the object column is', dis_object_check, '\n\n')
cat('The create NHAT function correctly created the distance column is', dis_distance_check, '\n\n')
cat('The create NHAT function correctly created the area column is', dis_area_check, '\n\n')
cat('The create NHAT function correctly created the size column is', dis_size_check, '\n\n')
cat('The create NHAT function correctly created the NHAT column is', dis_nhat_check, '\n\n')

```


```{r compare_count, echo=FALSE}

count_data_read_in <- read.csv("2.count.data.csv")


# has create count data created the columns correctly
if (length(colnames(count_data_read_in)) == length(colnames(count.data))) {
  count_data_check <- (length(colnames(count_data_read_in)) - sum(colnames(count.data) == colnames(count_data_read_in))) == 0
  count_area_check <- sum(count.data$area) == sum(count_data_read_in$area)
  count_nhat_check <- round(sum(count.data$NHAT, na.rm=T),6) == round(sum(count_data_read_in$NHAT, na.rm=T),6)
} else {
  count_data_check <- FALSE
  if ('area' %in% colnames(count.data)) {
    count_area_check <- sum(count.data$area, na.rm=T) == sum(count_data_read_in$area, na.rm=T)
  } else {
    count_area_check <- FALSE
  }
  if ('NHAT' %in% colnames(count.data)) {
    count_nhat_check <- round(sum(count.data$NHAT, na.rm=T),6) == round(sum(count_data_read_in$NHAT, na.rm=T), 6)
  } else {
    count_nhat_check <- FALSE
  }
}


```

```{r count_text, echo=FALSE, results='asis'}

cat('The create count data function created all the expected columns is', count_data_check, '\n\n')
cat('The create count data function correctly created the area column is', count_area_check, '\n\n')
cat('The create count data function correctly created the NHAT column is', count_nhat_check, '\n\n')

```
